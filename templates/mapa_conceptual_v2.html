<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Conceptual Interactivo - M茅todo Formal Causal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mapa_mental.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body class="mapa-body">
    <!-- Barra de navegaci贸n -->
    <nav class="mapa-nav">
        <div class="container">
            <div class="nav-content">
                <h1 class="nav-title">Mapa Conceptual Interactivo</h1>
                <div class="nav-buttons">
                    <a href="/informe/{{ informe_id }}" class="btn btn-secondary btn-small">Ver Informe Completo</a>
                    <a href="/" class="btn btn-secondary btn-small">Inicio</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Controles del mapa -->
    <div class="mapa-controles">
        <button onclick="zoomIn()" class="btn-control" title="Acercar (tecla +)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="11" y1="8" x2="11" y2="14"></line>
                <line x1="8" y1="11" x2="14" y2="11"></line>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>
        <button onclick="zoomOut()" class="btn-control" title="Alejar (tecla -)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="8" y1="11" x2="14" y2="11"></line>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>
        <button onclick="resetView()" class="btn-control" title="Restablecer vista (tecla R)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                <path d="M3 21v-5h5"></path>
            </svg>
        </button>
        <button onclick="expandirTodos()" class="btn-control" title="Expandir todo (tecla E)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 3 21 3 21 9"></polyline>
                <polyline points="9 21 3 21 3 15"></polyline>
                <line x1="21" y1="3" x2="14" y2="10"></line>
                <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
        </button>
        <button onclick="contraerTodos()" class="btn-control" title="Contraer todo (tecla C)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="4 14 10 14 10 20"></polyline>
                <polyline points="20 10 14 10 14 4"></polyline>
                <line x1="14" y1="10" x2="21" y2="3"></line>
                <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
        </button>
    </div>

    <!-- Canvas del mapa mental -->
    <div class="mapa-canvas" id="mapaCanvas">
        <!-- SVG para las conexiones -->
        <svg id="conexiones" class="conexiones-svg">
            <defs>
                <!-- Marcador de flecha -->
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#667eea" opacity="0.7" />
                </marker>
                
                <linearGradient id="gradPreceptivas" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#1976d2;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#42a5f5;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="gradTecnicas" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#f57c00;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ffb74d;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="gradFacultativas" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#388e3c;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#66bb6a;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="gradProgresistas" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#7b1fa2;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ba68c8;stop-opacity:1" />
                </linearGradient>
            </defs>
        </svg>
        
        <div class="nodos-contenedor" id="nodosContenedor">
            <!-- Nodo Central - Conjetura -->
            <div class="nodo nodo-raiz" id="nodo-raiz" data-nivel="0">
                <div class="nodo-inner">
                    <div class="nodo-icono">
                        <svg viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="3" fill="none"/>
                            <circle cx="50" cy="50" r="35" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/>
                            <circle cx="50" cy="50" r="8" fill="currentColor"/>
                        </svg>
                    </div>
                    <h3>Conjetura Inicial</h3>
                    <p class="nodo-texto">{{ informe.conjetura }}</p>
                </div>
            </div>

            <!-- Motivaciones Preceptivas -->
            <div class="nodo nodo-motivacion preceptivas" id="nodo-preceptivas" data-nivel="1" data-tipo="preceptivas" onclick="toggleNodo(this)">
                <div class="nodo-inner">
                    <div class="nodo-header">
                        <span class="nodo-icono-small"></span>
                        <h4>Preceptivas</h4>
                        <span class="toggle-icon">+</span>
                    </div>
                    <p class="nodo-desc">Del enunciado del problema</p>
                    <div class="nodo-detalles">
                        {% for motivacion in informe.analisis.por_que.preceptivas %}
                        <div class="detalle-item">
                            <strong>{{ motivacion.titulo }}</strong>
                            <p>{{ motivacion.contenido }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Motivaciones T茅cnicas -->
            <div class="nodo nodo-motivacion tecnicas" id="nodo-tecnicas" data-nivel="1" data-tipo="tecnicas" onclick="toggleNodo(this)">
                <div class="nodo-inner">
                    <div class="nodo-header">
                        <span class="nodo-icono-small">锔</span>
                        <h4>T茅cnicas</h4>
                        <span class="toggle-icon">+</span>
                    </div>
                    <p class="nodo-desc">Leyes y normativas</p>
                    <div class="nodo-detalles">
                        {% for motivacion in informe.analisis.por_que.tecnicas %}
                        <div class="detalle-item">
                            <strong>{{ motivacion.titulo }}</strong>
                            <p>{{ motivacion.contenido }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Motivaciones Facultativas -->
            <div class="nodo nodo-motivacion facultativas" id="nodo-facultativas" data-nivel="1" data-tipo="facultativas" onclick="toggleNodo(this)">
                <div class="nodo-inner">
                    <div class="nodo-header">
                        <span class="nodo-icono-small"></span>
                        <h4>Facultativas</h4>
                        <span class="toggle-icon">+</span>
                    </div>
                    <p class="nodo-desc">Motivaci贸n profesional</p>
                    <div class="nodo-detalles">
                        {% for motivacion in informe.analisis.por_que.facultativas %}
                        <div class="detalle-item">
                            <strong>{{ motivacion.titulo }}</strong>
                            <p>{{ motivacion.contenido }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Motivaciones Progresistas -->
            <div class="nodo nodo-motivacion progresistas" id="nodo-progresistas" data-nivel="1" data-tipo="progresistas" onclick="toggleNodo(this)">
                <div class="nodo-inner">
                    <div class="nodo-header">
                        <span class="nodo-icono-small"></span>
                        <h4>Progresistas</h4>
                        <span class="toggle-icon">+</span>
                    </div>
                    <p class="nodo-desc">Aportaci贸n al conocimiento</p>
                    <div class="nodo-detalles">
                        {% for motivacion in informe.analisis.por_que.progresistas %}
                        <div class="detalle-item">
                            <strong>{{ motivacion.titulo }}</strong>
                            <p>{{ motivacion.contenido }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Objetivos (Para qu茅s) -->
            {% for objetivo in informe.analisis.para_que %}
            <div class="nodo nodo-objetivo {{ objetivo.tipo }}" 
                 id="nodo-objetivo-{{ loop.index }}" 
                 data-nivel="2" 
                 data-tipo="{{ objetivo.tipo }}"
                 onclick="toggleNodo(this)">
                <div class="nodo-inner">
                    <div class="nodo-header">
                        <span class="nodo-badge">
                            {% if objetivo.tipo == 'preceptivas' %}
                            {% elif objetivo.tipo == 'tecnicas' %}锔
                            {% elif objetivo.tipo == 'facultativas' %}
                            {% else %}{% endif %}
                        </span>
                        <h5>{{ objetivo.titulo }}</h5>
                    </div>
                    <div class="nodo-detalles">
                        <p>{{ objetivo.contenido }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Nodo "Qu茅 es" -->
            <div class="nodo nodo-definicion" id="nodo-definicion" data-nivel="3" onclick="toggleNodo(this)">
                <div class="nodo-inner">
                    <div class="nodo-header">
                        <span class="nodo-icono-small"></span>
                        <h4>驴Qu茅 es?</h4>
                        <span class="toggle-icon">+</span>
                    </div>
                    <p class="nodo-desc">Definici贸n y Contextualizaci贸n</p>
                    <div class="nodo-detalles">
                        <div class="detalle-item">
                            <strong>Definici贸n</strong>
                            <p>{{ informe.analisis.que_es.contenido }}</p>
                        </div>
                        <div class="detalle-item">
                            <strong>Contexto</strong>
                            <p>{{ informe.analisis.que_es.contexto }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leyenda -->
    <div class="mapa-leyenda">
        <h4>Leyenda</h4>
        <div class="leyenda-item"><span class="color-box preceptivas"></span> Preceptivas</div>
        <div class="leyenda-item"><span class="color-box tecnicas"></span> T茅cnicas</div>
        <div class="leyenda-item"><span class="color-box facultativas"></span> Facultativas</div>
        <div class="leyenda-item"><span class="color-box progresistas"></span> Progresistas</div>
    </div>

    <!-- Informaci贸n de ayuda -->
    <div class="mapa-ayuda">
        <button onclick="toggleAyuda()" class="btn-ayuda">?</button>
        <div class="ayuda-panel" id="ayudaPanel">
            <h4>Controles</h4>
            <ul>
                <li><strong>Click</strong> en nodo: Expandir/contraer</li>
                <li><strong>Arrastrar</strong>: Mover vista</li>
                <li><strong>Rueda rat贸n</strong>: Zoom</li>
                <li><strong>+/-</strong>: Acercar/alejar</li>
                <li><strong>R</strong>: Restablecer vista</li>
                <li><strong>E</strong>: Expandir todo</li>
                <li><strong>C</strong>: Contraer todo</li>
            </ul>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/mapa_mental.js') }}"></script>
    <script>
        // Pasar datos al JavaScript
        const informeData = {
            motivaciones: {
                preceptivas: {{ informe.analisis.por_que.preceptivas|length }},
                tecnicas: {{ informe.analisis.por_que.tecnicas|length }},
                facultativas: {{ informe.analisis.por_que.facultativas|length }},
                progresistas: {{ informe.analisis.por_que.progresistas|length }}
            },
            objetivos: {{ informe.analisis.para_que|length }}
        };
    </script>
</body>
</html>
